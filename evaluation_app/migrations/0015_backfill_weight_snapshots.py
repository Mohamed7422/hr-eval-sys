# Generated by Django 5.2.1 on 2025-11-08 21:29

from django.db import migrations

def backfill_weights(apps, schema_editor):
    Evaluation = apps.get_model('evaluation_app', 'Evaluation')
    WeightsConfiguration = apps.get_model('evaluation_app', 'WeightsConfiguration')
    
    for eval in Evaluation.objects.select_related("employee").all():
        try:
            weights = WeightsConfiguration.objects.get(
                level_name=eval.employee.managerial_level
            )
            eval.obj_weight_pct = weights.objective_weight or 0
            eval.comp_weight_pct = weights.competency_weight or 0
            eval.comp_core_pct = weights.core_weight or 0
            eval.comp_leadership_pct = weights.leadership_weight or 0
            eval.comp_functional_pct = weights.functional_weight or 0
            eval.save(update_fields=[
                "obj_weight_pct",
                "comp_weight_pct", 
                "comp_core_pct",
                "comp_leadership_pct",
                "comp_functional_pct"
            ])
        except WeightsConfiguration.DoesNotExist:
            continue

class Migration(migrations.Migration):

    dependencies = [
        ('evaluation_app', '0014_add_eval_weight_snapshots'),
    ]

    operations = [
        migrations.RunPython(backfill_weights, reverse_code=migrations.RunPython.noop),
    ]
